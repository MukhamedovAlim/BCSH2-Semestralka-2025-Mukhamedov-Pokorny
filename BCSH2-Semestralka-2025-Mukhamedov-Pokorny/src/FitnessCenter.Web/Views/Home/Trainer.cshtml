@{
    ViewData["Title"] = "Trenér – Přehled";
    Layout = "_AppLayout";
    ViewBag.Active = "HomeTrainer";

    DateTime today = ViewBag.Today is DateTime d ? d : DateTime.Today;

    // Dnešní lekce – demo s Id kvůli routování
    var lessonsToday = new[]
    {
        new { Id = 1, Time = "08:00", Name = "Kruháč",   Room = "Sál A", Slots = "12/20" },
        new { Id = 2, Time = "17:00", Name = "Jóga",     Room = "Sál B", Slots = "18/20" },
        new { Id = 3, Time = "19:00", Name = "Crossfit", Room = "Sál A", Slots = "12/12" },
    };
}

<!-- Úvodní panel -->
<div class="glass p-3 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div>
            <h3 class="text-white mb-1">Ahoj, trenére @(User.Identity?.Name ?? "") 👋</h3>
            <div class="text-white-50">Dnes je @today.ToString("dddd d. MMMM yyyy")</div>
        </div>
        <div class="mt-2 mt-md-0">
            <a href="@Url.Action("Create","Lessons")" class="btn btn-sm btn-warning">
                + Vytvořit lekci
            </a>
        </div>
    </div>

    <hr class="border-secondary my-3" />

    <div class="row g-3">
        <!-- Dnešní lekce -->
        <div class="col-12 col-xl-7">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-white mb-0">Dnešní lekce</h5>
                    <a class="btn btn-sm btn-outline-light" href="@Url.Action("Index","Lessons")">Správa lekcí</a>
                </div>

                @if (lessonsToday.Length == 0)
                {
                    <div class="text-white-50 small">Dnes nemáš žádné naplánované lekce.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-dark table-sm align-middle mb-0">
                            <thead>
                                <tr class="text-white-50">
                                    <th style="width:90px;">Čas</th>
                                    <th>Lekce</th>
                                    <th style="width:140px;">Místnost</th>
                                    <th style="width:120px;">Obsazeno</th>
                                    <th style="width:160px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var l in lessonsToday)
                                {
                                    <tr>
                                        <td>@l.Time</td>
                                        <td class="text-white">@l.Name</td>
                                        <td>@l.Room</td>
                                        <td>@l.Slots</td>
                                        <td class="text-end">
                                            <a href="@Url.Action("Detail","Lessons", new { id = l.Id })" class="btn btn-sm btn-outline-light">Detail</a>
                                            <a href="@Url.Action("Attendance","Lessons", new { id = l.Id })" class="btn btn-sm btn-warning ms-1">Docházka</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

        <!-- Poznámkový blok (lokální uložení) -->
        <div class="col-12 col-xl-5">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="text-white mb-0">Poznámkový blok</h5>
                    <span class="text-white-50 small">(uloženo v tomto prohlížeči)</span>
                </div>

                <textarea id="trainer-notes" class="form-control notes-textarea" rows="8"
                          placeholder="Napiš si sem, na co nezapomenout…"></textarea>

                <div class="d-flex justify-content-end mt-2 gap-2">
                    <button id="notes-delete" type="button" class="btn btn-outline-light btn-sm">Smazat</button>
                    <button id="notes-primary" type="button" class="btn btn-warning btn-sm">Uložit</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rychlé akce – 4 boxy (Vybavení je poslední) -->
<div class="glass p-3">
    <h4 class="text-white mb-2">Rychlé akce</h4>
    <div class="row g-3 mt-0">

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Moje lekce</h5>
                <div class="text-white-50 small">Vytváření, editace, kalendář.</div>
                <a href="@Url.Action("Index","Lessons")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Zprávy členům</h5>
                <div class="text-white-50 small">Hromadné nebo cílené zprávy.</div>
                <a href="@Url.Action("Index","Messages")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Vytvořit lekci</h5>
                <div class="text-white-50 small">Přidej novou lekci.</div>
                <a href="@Url.Action("Create","Lessons")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Vybavení</h5>
                <div class="text-white-50 small">Kardio, stroje, volná závaží.</div>
                <a href="@Url.Action("Index","Equipment")" class="stretched-link"></a>
            </div>
        </div>

    </div>
</div>

<style>
  /* světle šedé pole, aby ladilo s tmavým tématem */
  .notes-textarea {
    background: rgba(255,255,255,0.08);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.18);
  }
  .notes-textarea::placeholder {
    color: rgba(255,255,255,0.55);
  }
  .notes-textarea:focus {
    background: rgba(255,255,255,0.10);
    color: #fff;
    border-color: rgba(255,255,255,0.35);
    box-shadow: none;
  }
</style>

@section scripts {
<script>
  (function () {
    const KEY = 'trainer_notes_v1';
    const ta = document.getElementById('trainer-notes');
    const btnPrimary = document.getElementById('notes-primary'); // Uložit/Upravit
    const btnDelete  = document.getElementById('notes-delete');

    // stav: 'editing' | 'saved'
    let state = 'editing';
    let autosaveTimer = null;

    function setState(newState) {
      state = newState;
      if (state === 'saved') {
        ta.readOnly = true;
        btnPrimary.textContent = 'Upravit';
      } else {
        ta.readOnly = false;
        btnPrimary.textContent = 'Uložit';
      }
    }

    function load() {
      try {
        const v = localStorage.getItem(KEY);
        if (v !== null && v !== undefined) {
          ta.value = v;
          if (v.trim().length > 0) setState('saved'); else setState('editing');
        } else {
          setState('editing');
        }
      } catch (_) { setState('editing'); }
    }

    function save() {
      try { localStorage.setItem(KEY, ta.value || ''); } catch (_) {}
    }

    // primární tlačítko: Uložit ↔ Upravit
    btnPrimary.addEventListener('click', () => {
      if (state === 'editing') {
        save();
        setState('saved');
      } else {
        setState('editing');
        ta.focus();
        const len = ta.value.length;
        ta.setSelectionRange(len, len);
      }
    });

    // Smazat – vymaže text i storage a přepne do „editing“
    btnDelete.addEventListener('click', () => {
      ta.value = '';
      try { localStorage.removeItem(KEY); } catch (_) {}
      setState('editing');
      ta.focus();
    });

    // autosave při psaní (jen v editing stavu)
    ta.addEventListener('input', () => {
      if (state !== 'editing') return;
      clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(save, 600);
    });

    load();
  })();
</script>
}

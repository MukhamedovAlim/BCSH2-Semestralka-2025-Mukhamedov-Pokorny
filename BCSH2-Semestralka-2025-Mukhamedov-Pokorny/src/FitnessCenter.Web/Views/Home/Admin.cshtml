@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Admin – Přehled";
    Layout = "_AppLayout";
    ViewBag.Active = ViewBag.Active ?? "Admin";

    int membersCount = ViewBag.MembersCount is int mc ? mc : 0;
    int trainersCount = ViewBag.TrainersCount is int tc ? tc : 0;
    int lessonsToday = ViewBag.LessonsToday is int lt ? lt : 0;
    int pendingPayments = ViewBag.PendingPayments is int pp ? pp : 0;

    DateTime today = ViewBag.Today is DateTime d ? d : DateTime.Today;

    // ---- pro funkční boxy (DB funkce) ----
    int fitkoId = ViewBag.FitkoId is int f ? f : 1;
    DateTime periodFrom = ViewBag.PeriodFrom is DateTime pf ? pf : DateTime.Today.AddDays(-30);
    DateTime periodTo = ViewBag.PeriodTo is DateTime pt ? pt : DateTime.Today;

    int activeMembersFunc = ViewBag.ActiveMembersFunc is int amf ? amf : 0;
    decimal incomeFunc = ViewBag.IncomeFunc is decimal inc ? inc : 0m;
    string memberFuncText = ViewBag.MemberFuncText as string ?? "—";

    var fitness = ViewBag.FitnessCenters as IEnumerable<SelectListItem>
                  ?? ViewBag.Fitka as IEnumerable<SelectListItem>
                  ?? Enumerable.Empty<SelectListItem>();

    var members = ViewBag.MembersInFitness as IEnumerable<SelectListItem>
                  ?? Enumerable.Empty<SelectListItem>();

    int selectedMemberId = ViewBag.MemberId is int mid ? mid : 0;

    // ---- pro graf tržeb ----
    var revenueLabels = ViewBag.RevenueLabels as IEnumerable<string>
                        ?? Enumerable.Empty<string>();
    var revenueValues = ViewBag.RevenueValues as IEnumerable<decimal>
                        ?? Enumerable.Empty<decimal>();

    // ---- pro členské statistiky ----
    var memberTypes = ViewBag.MemberTypes as IEnumerable<string>
                      ?? Enumerable.Empty<string>();
    var memberCounts = ViewBag.MemberCounts as IEnumerable<int>
                       ?? Enumerable.Empty<int>();

    // ---- pro top trenéry ----
    var topTrainerNames = ViewBag.TopTrainerNames as IEnumerable<string> ?? Enumerable.Empty<string>();
    var topTrainerCounts = ViewBag.TopTrainerCounts as IEnumerable<int> ?? Enumerable.Empty<int>();

    // ---- pro graf vybavení (stav podle fitka) ----
    var equipCenterLabels = ViewBag.EquipCenterLabels as IEnumerable<string> ?? Enumerable.Empty<string>();
    var equipOkCounts = ViewBag.EquipOkCounts as IEnumerable<int> ?? Enumerable.Empty<int>();
    var equipRepairCounts = ViewBag.EquipRepairCounts as IEnumerable<int> ?? Enumerable.Empty<int>();
    var equipOutCounts = ViewBag.EquipOutCounts as IEnumerable<int> ?? Enumerable.Empty<int>();

}

<style>
    /* Taby Analytika – Tržby / Vybavení */
    #analyticsTabs .nav-link {
        color: #ffffff;
        background: transparent;
        border-radius: 999px;
        padding: 0.35rem 1.1rem;
        border: 1px solid transparent;
    }
</style>

<!-- Úvodní panel -->
<div class="glass p-3 mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <div>
            <h3 class="text-white mb-1">Ahoj, admine @(User.Identity?.Name ?? "") 👋</h3>
            <div class="text-white-50">Dnes je @today.ToString("dddd d. MMMM yyyy")</div>
        </div>
        <div class="mt-2 mt-md-0">
            <a href="@Url.Action("Create", "Members")" class="btn btn-sm btn-warning">
                + Přidat člena
            </a>
        </div>
    </div>

    <hr class="border-secondary my-3" />

    <div class="row g-3">
        <!-- Členové -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between">
                    <h5 class="text-white mb-2">Členové</h5>
                    <span class="badge bg-info">@membersCount</span>
                </div>
                <div class="text-white-50 small mb-2">Aktivní záznamy v systému.</div>
                <a class="stretched-link" href="@Url.Action("Index", "Members")"></a>
            </div>
        </div>

        <!-- Trenéři -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between">
                    <h5 class="text-white mb-2">Trenéři</h5>
                    <span class="badge bg-info">@trainersCount</span>
                </div>
                <div class="text-white-50 small mb-2">Správa trenérů a kvalifikací.</div>
                <a class="stretched-link" href="@Url.Action("Index", "AdminTrainers")"></a>
            </div>
        </div>

        <!-- Dnešní lekce -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between">
                    <h5 class="text-white mb-2">Přehled Lekcí</h5>
                    <span class="badge bg-info">@lessonsToday</span>
                </div>
                <div class="text-white-50 small mb-2">Rozvrh a kapacity.</div>
                <a class="stretched-link" href="@Url.Action("Index", "AdminLessons")"></a>
            </div>
        </div>

        <!-- Vybavení -->
        <div class="col-12 col-sm-6 col-xl-3">
            <div class="tile glass h-100">
                <div class="d-flex justify-content-between">
                    <h5 class="text-white mb-2">Vybavení</h5>
                    <span class="badge bg-info">@((int)(ViewBag.EquipmentCount ?? 0))</span>
                </div>
                <div class="text-white-50 small mb-2">Přehled a správa vybavení.</div>
                <a class="stretched-link" href="@Url.Action("Index", "Equipment")"></a>
            </div>
        </div>
    </div>
</div>

<!-- Rychlé akce -->
<div class="glass p-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <h4 class="text-white mb-0">Rychlé akce</h4>
    </div>
    <div class="row g-3 mt-1">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Log operací</h5>
                <div class="text-white-50 small">Poslední záznamy: <strong>@((int)(ViewBag.LogCount ?? 0))</strong></div>
                <a href="@Url.Action("Index", "AdminLogs")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Prodej členství</h5>
                <div class="text-white-50 small">Založit členství a platbu.</div>
                <a href="@Url.Action("Sell", "AdminMemberships")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Platby</h5>
                <div class="text-white-50 small">
                    Neuhrazené: <strong>@pendingPayments</strong>
                </div>
                <a href="@Url.Action("Index", "AdminPayments")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Trenéři & vytížení</h5>
                <div class="text-white-50 small">
                    Seznam trenérů a obsazenost jejich lekcí.
                </div>
                <a href="@Url.Action("AdminPreview", "AdminTrainers")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Certifikáty členů</h5>
                <div class="text-white-50 small">
                    Nahrané dokumenty a potvrzení.
                </div>
                <a href="@Url.Action("Index", "AdminMemberCertificates")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Systémový katalog</h5>
                <div class="text-white-50 small">
                    Databázové objekty
                </div>
                <a href="@Url.Action("Index", "DbCatalog")" class="stretched-link"></a>
            </div>
        </div>

        <div class="col-12 col-md-6 col-xl-3">
            <div class="tile glass quick-tile position-relative h-100">
                <h5 class="text-white mb-1">Kalendář</h5>
                <div class="text-white-50 small">
                    Měsíční přehled všech lekcí.
                </div>
                <a href="@Url.Action("Calendar", "AdminLessons")" class="stretched-link"></a>
            </div>
        </div>

    </div>
</div>


<!-- ===== Boxy napojené na DB FUNKCE ===== -->
<div class="glass p-3 mt-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap">
        <h4 class="text-white mb-0">Funkční přehled</h4>
    </div>

    <!-- Filtr (fitko + období) -->
    <div class="mt-3">
        <form method="get" asp-action="Admin" class="row g-2 align-items-end">
            <div class="col-12 col-md-3">
                <label class="form-label text-white">Fitness centrum</label>
                <select name="fitko" class="form-select">
                    @foreach (var it in fitness)
                    {
                        var sel = (fitkoId.ToString() == it.Value) ? "selected" : null;
                        <option value="@it.Value" @sel>@it.Text</option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-3">
                <label class="form-label text-white">Člen (pro hodnocení)</label>
                <select name="memberId" class="form-select">
                    <option value="">— nevybrán —</option>
                    @foreach (var m in members)
                    {
                        var sel = (selectedMemberId != 0 && selectedMemberId.ToString() == m.Value) ? "selected" : null;
                        <option value="@m.Value" @sel>@m.Text</option>
                    }
                </select>
            </div>

            <div class="col-6 col-md-2">
                <label class="form-label text-white">Od</label>
                <input type="date" name="od" class="form-control" value="@periodFrom.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-6 col-md-2">
                <label class="form-label text-white">Do</label>
                <input type="date" name="do" class="form-control" value="@periodTo.ToString("yyyy-MM-dd")" />
            </div>
            <div class="col-12 col-md-2">
                <button class="btn btn-warning w-100" type="submit">Použít</button>
            </div>
        </form>

    </div>

    <!-- Výstupy funkcí -->
    <div class="row g-3 mt-1">
        <div class="col-12 col-md-4">
            <div class="glass p-3 h-100">
                <div class="text-white-50 small">Aktivní členové (fitko)</div>
                <div class="display-6 text-white">@activeMembersFunc</div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="glass p-3 h-100">
                <div class="text-white-50 small">Příjem za období</div>
                <div class="text-white">@periodFrom.ToString("d.M.yyyy") – @periodTo.ToString("d.M.yyyy")</div>
                <div class="display-6 text-white mt-1">@incomeFunc.ToString("N0") Kč</div>
            </div>
        </div>

        <div class="col-12 col-md-4">
            <div class="glass p-3 h-100">
                <div class="text-white-50 small">Hodnocení člena</div>
                <div class="text-white">@memberFuncText</div>
            </div>
        </div>
    </div>

    <!-- ===== Analytika – Tržby / Vybavení ===== -->
    <div class="glass p-3 mt-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
            <div>
                <h4 class="text-white mb-0">Analytika</h4>
                <span class="text-white-50 small">
                    Přehled denních tržeb a stavu vybavení ve fitness centrech.
                </span>
            </div>

            <ul class="nav nav-pills ms-auto" id="analyticsTabs">
                <li class="nav-item">
                    <button type="button"
                            class="nav-link active"
                            data-target="revenuePanel">
                        Tržby
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button"
                            class="nav-link"
                            data-target="equipmentPanel">
                        Vybavení
                    </button>
                </li>
            </ul>
        </div>

        <!-- PANEL: Tržby -->
        <div id="revenuePanel">
            <div class="row g-2 mb-3">
                <div class="col-12 d-flex justify-content-end flex-wrap gap-3 rev-filter-wrapper">

                    <div class="rev-filter-group">
                        <label class="form-label text-white-50 mb-1 small">Období</label>
                        <select id="revRange" class="form-select form-select-sm rev-filter-select">
                            <option value="7">Posledních 7 dní</option>
                            <option value="14">Posledních 14 dní</option>
                            <option value="30">Posledních 30 dní</option>
                            <option value="all" selected>Celé období</option>
                        </select>
                    </div>

                    <div class="rev-filter-group">
                        <label class="form-label text-white-50 mb-1 small">Zobrazení</label>
                        <select id="revChartType" class="form-select form-select-sm rev-filter-select">
                            <option value="line" selected>Čárový</option>
                            <option value="bar">Sloupcový</option>
                        </select>
                    </div>

                    <div class="rev-filter-group">
                        <label class="form-label text-white-50 mb-1 small">&nbsp;</label>

                        <div class="form-check d-flex align-items-center m-0">
                            <input class="form-check-input me-2" type="checkbox" value="1" id="revShowCumulative" />
                            <label class="form-check-label text-white-50 small" for="revShowCumulative">
                                Kumulativně
                            </label>
                        </div>
                    </div>

                </div>
            </div>

            <div class="glass p-3">
                <div style="height: 260px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PANEL: Vybavení -->
        <div id="equipmentPanel" class="d-none">
            <div class="glass p-3 mt-2">
                <div style="height: 260px;">
                    <canvas id="equipmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Podíl typů členství + Nejvytíženější trenéři ===== -->
    <div class="glass p-3 mt-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap mb-2">
            <h4 class="text-white mb-0">Členství a trenéři</h4>
            <span class="text-white-50 small">
                Rozložení typů členství a top trenéři podle počtu rezervací.
            </span>
        </div>

        <div class="row g-3 align-items-stretch">
            <!-- Levá část – koláč typů členství -->
            <div class="col-12 col-lg-4">
                <div class="h-100 d-flex flex-column">
                    <h5 class="text-white mb-2">Podíl typů členství</h5>

                    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                        <div style="width:260px; height:260px;">
                            <canvas id="membershipPie"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pravá část – bar chart trenérů -->
            <div class="col-12 col-lg-8">
                <div class="h-100 d-flex flex-column">
                    <h5 class="text-white mb-2">Nejvytíženější trenéři</h5>
                    <div class="flex-grow-1" style="min-height:260px;">
                        <canvas id="topTrainersBar"></canvas>
                    </div>
                    <div class="text-white-50 small mt-1">
                        Top trenéři podle počtu rezervací na lekce.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ===== Line/Bar chart – denní tržby =====
        const revenueLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenueLabels));
        const revenueData   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(revenueValues));

        const ctx = document.getElementById('revenueChart');
        const typeSelect = document.getElementById('revChartType');
        const cumulativeCheckbox = document.getElementById('revShowCumulative');
        const rangeSelect = document.getElementById('revRange');

        // full data (co přišlo ze serveru)
        const fullLabels = Array.isArray(revenueLabels) ? revenueLabels : [];
        const fullDailyData = Array.isArray(revenueData) ? revenueData.map(Number) : [];

        // kumulativní data pro celé období
        const fullCumulativeData = [];
        let sum = 0;
        for (let i = 0; i < fullDailyData.length; i++) {
            const v = isNaN(fullDailyData[i]) ? 0 : fullDailyData[i];
            sum += v;
            fullCumulativeData.push(sum);
        }

        let currentType = 'line';
        let showCumulative = false;
        let currentRange = 'all';
        let revenueChart = null;

        // pomocná funkce – datum ve formátu "dd.MM.yyyy" -> Date
        function parseCzDate(str) {
            if (!str) return null;
            const parts = str.split(".");
            if (parts.length < 3) return null;

            const d = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1; // měsíce 0–11
            const y = parseInt(parts[2], 10);

            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m, d);
        }

        function sliceByRange(labels, daily, cumulative, rangeKey) {
            if (!labels.length) {
                return { labels: [], daily: [], cumulative: [] };
            }

            if (rangeKey === 'all') {
                return { labels, daily, cumulative };
            }

            const n = parseInt(rangeKey, 10);
            if (isNaN(n) || n <= 0) {
                return { labels, daily, cumulative };
            }

            // vezmeme datum POSLEDNÍHO bodu a spočítáme "od" (n-1 dní zpět)
            const lastLabel = labels[labels.length - 1];
            const lastDate = parseCzDate(lastLabel);
            if (!lastDate) {
                // fallback – kdyby se datum nepodařilo parse-nout, chovej se jako dřív
                const startIndexFallback = Math.max(labels.length - n, 0);
                return {
                    labels: labels.slice(startIndexFallback),
                    daily: daily.slice(startIndexFallback),
                    cumulative: cumulative.slice(startIndexFallback)
                };
            }

            const minDate = new Date(lastDate);
            minDate.setDate(minDate.getDate() - (n - 1));

            // najdeme první index, který už spadá do rozsahu
            let startIndex = 0;
            for (let i = 0; i < labels.length; i++) {
                const d = parseCzDate(labels[i]);
                if (d && d >= minDate) {
                    startIndex = i;
                    break;
                }
            }

            return {
                labels: labels.slice(startIndex),
                daily: daily.slice(startIndex),
                cumulative: cumulative.slice(startIndex)
            };
        }

        function buildRevenueDataset(dataArray) {
            const labelText = showCumulative ? 'Kumulativní tržby (Kč)' : 'Tržby (Kč)';

            return {
                label: labelText,
                data: dataArray,
                borderWidth: 3,
                borderColor: '#ffc107',
                backgroundColor: currentType === 'line'
                    ? 'rgba(255,193,7,0.15)'
                    : 'rgba(255,193,7,0.6)',
                pointBackgroundColor: '#ffc107',
                pointBorderColor: '#ffffff',
                pointRadius: 3,
                pointHoverRadius: 5,
                fill: currentType === 'line',
                tension: 0.25
            };
        }

        function rebuildRevenueChart() {
            if (!ctx || fullLabels.length === 0) return;

            // vybereme subset podle range
            const subset = sliceByRange(fullLabels, fullDailyData, fullCumulativeData, currentRange);
            const dataArray = showCumulative ? subset.cumulative : subset.daily;

            const config = {
                type: currentType,
                data: {
                    labels: subset.labels,
                    datasets: [buildRevenueDataset(dataArray)]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (ctx2) {
                                    var y = ctx2 && ctx2.parsed && typeof ctx2.parsed.y === 'number'
                                        ? ctx2.parsed.y
                                        : 0;
                                    return y.toLocaleString('cs-CZ') + ' Kč';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#bfbfbf' },
                            grid: { color: 'rgba(255,255,255,0.06)' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#bfbfbf',
                                callback: function (value) {
                                    return value.toLocaleString('cs-CZ');
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.06)' }
                        }
                    }
                }
            };

            if (revenueChart) {
                revenueChart.destroy();
            }
            revenueChart = new Chart(ctx, config);
        }

        // inicializace
        if (ctx && fullLabels.length > 0) {
            rebuildRevenueChart();
        }

        // změna typu grafu (čára <-> sloupce)
        if (typeSelect) {
            typeSelect.addEventListener('change', function () {
                currentType = this.value || 'line';
                rebuildRevenueChart();
            });
        }

        // přepnutí Kumulativně / Denní
        if (cumulativeCheckbox) {
            cumulativeCheckbox.addEventListener('change', function () {
                showCumulative = this.checked;
                rebuildRevenueChart();
            });
        }

        // změna rozsahu (Celé / 7 / 14 / 30 dní)
        if (rangeSelect) {
            rangeSelect.addEventListener('change', function () {
                currentRange = this.value || 'all';
                rebuildRevenueChart();
            });
        }

        // ===== Pie chart – podíl typů členství =====
        const memberTypes  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(memberTypes));
        const memberCounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(memberCounts));

        const pieCtx = document.getElementById('membershipPie');

        if (pieCtx && memberTypes.length > 0) {
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: memberTypes,
                    datasets: [{
                        data: memberCounts,
                        backgroundColor: [
                            '#ffc107',
                            '#17a2b8',
                            '#dc3545',
                            '#6f42c1',
                            '#28a745'
                        ],
                        borderColor: '#222',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // ===== Bar chart – nejvytíženější trenéři =====
        const topTrainerNames  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(topTrainerNames));
        const topTrainerCounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(topTrainerCounts));

        const barCtx = document.getElementById('topTrainersBar');

        if (barCtx && topTrainerNames.length > 0) {
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: topTrainerNames,
                    datasets: [{
                        label: 'Počet rezervací',
                        data: topTrainerCounts,
                        backgroundColor: '#ffc107',
                        borderColor: '#ffd65a',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (ctx2) {
                                    var y = ctx2 && ctx2.parsed && typeof ctx2.parsed.y === 'number'
                                        ? ctx2.parsed.y
                                        : 0;
                                    return y.toLocaleString('cs-CZ') + ' rezervací';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#bfbfbf' },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#bfbfbf',
                                precision: 0
                            },
                            grid: { color: 'rgba(255,255,255,0.06)' }
                        }
                    }
                }
            });
        }

        // ===== Stacked bar – stav vybavení podle fitka =====
        const equipLabels       = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(equipCenterLabels));
        const equipOkCounts     = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(equipOkCounts));
        const equipRepairCounts = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(equipRepairCounts));
        const equipOutCounts    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(equipOutCounts));

        const equipCtx = document.getElementById('equipmentChart');

        if (equipCtx && equipLabels.length > 0) {
            new Chart(equipCtx, {
                type: 'bar',
                data: {
                    labels: equipLabels,
                    datasets: [
                        {
                            label: 'OK',
                            data: equipOkCounts,
                            backgroundColor: '#28a745'
                        },
                        {
                            label: 'Oprava',
                            data: equipRepairCounts,
                            backgroundColor: '#ffc107'
                        },
                        {
                            label: 'Mimo provoz',
                            data: equipOutCounts,
                            backgroundColor: '#dc3545'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (ctx2) {
                                    const v = ctx2.parsed.y ?? 0;
                                    return v.toLocaleString('cs-CZ') + ' ks';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: '#bfbfbf' },
                            grid: { display: false }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                color: '#bfbfbf',
                                precision: 0
                            },
                            grid: { color: 'rgba(255,255,255,0.06)' }
                        }
                    }
                }
            });
        }

        // ===== Přepínání tabů Tržby / Vybavení =====
        const analyticsTabs = document.querySelectorAll('#analyticsTabs .nav-link');
        const revenuePanel = document.getElementById('revenuePanel');
        const equipmentPanel = document.getElementById('equipmentPanel');

        analyticsTabs.forEach(btn => {
            btn.addEventListener('click', function () {
                analyticsTabs.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const target = this.getAttribute('data-target');
                if (target === 'equipmentPanel') {
                    revenuePanel.classList.add('d-none');
                    equipmentPanel.classList.remove('d-none');
                } else {
                    equipmentPanel.classList.add('d-none');
                    revenuePanel.classList.remove('d-none');
                }
            });
        });
    </script>
}
